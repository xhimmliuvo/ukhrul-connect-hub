

# Fix: Auto-create Agent Profile When Agent Role is Assigned

## Problem Identified
When you assign the 'agent' role to a user (like Shimray), only a `user_roles` record is created. The system is missing a database trigger that automatically creates the corresponding `delivery_agents` profile.

**Current state:**
- `user_roles` table: Has 2 agents (Hashtag Dropee and Shimray)
- `delivery_agents` table: Empty (0 records)

## Solution

### 1. Database Migration
Create a trigger on `user_roles` table that fires when the 'agent' role is inserted.

**New function: `create_agent_on_role_assignment()`**
- Triggers AFTER INSERT on `user_roles` when `role = 'agent'`
- Pulls user data from `profiles` table (full_name, phone, avatar_url)
- Creates a new `delivery_agents` record with:
  - `user_id` from the role assignment
  - `full_name` from profiles (or "Agent" as fallback)
  - `phone` and `avatar_url` from profiles
  - `agent_code` auto-generated by existing trigger
  - Default values for `vehicle_type` ('bike'), `is_active` (true), `is_verified` (false)

**Trigger: `trigger_create_agent_on_role`**
```
AFTER INSERT ON public.user_roles
FOR EACH ROW
WHEN (NEW.role = 'agent')
EXECUTE FUNCTION create_agent_on_role_assignment()
```

### 2. Backfill Existing Agent Roles
Run a one-time INSERT to create `delivery_agents` records for the 2 existing users who already have the 'agent' role but no agent profile.

```sql
INSERT INTO delivery_agents (user_id, full_name, phone, avatar_url)
SELECT 
  ur.user_id,
  COALESCE(p.full_name, 'Agent'),
  p.phone,
  p.avatar_url
FROM user_roles ur
LEFT JOIN profiles p ON p.id = ur.user_id
WHERE ur.role = 'agent'
  AND NOT EXISTS (
    SELECT 1 FROM delivery_agents da WHERE da.user_id = ur.user_id
  )
```

### 3. Optional Enhancement: Handle Role Removal
Create a trigger to soft-delete (set `is_active = false`) the agent profile when the 'agent' role is removed from a user.

---

## Files to Modify

| Action | File | Description |
|--------|------|-------------|
| Create | Migration SQL | Add trigger on user_roles + backfill existing agents |

---

## Expected Result After Fix

| Table | Record Count |
|-------|-------------|
| `user_roles` (agent) | 2 (unchanged) |
| `delivery_agents` | 2 (created) |
| `agent_availability` | 2 (auto-created by existing trigger) |

Both Shimray and Hashtag Dropee will appear in `/admin/agents` with auto-generated codes (DRP001, DRP002).

